# Iteration v0.2 — Database CRUD with Provisioning

## Goal
Full database lifecycle — create a database (provisions CNPG Cluster + PgBouncer Pooler), list/get/update/delete databases, return connection details + credentials to developers.

## Features
- [ ] Platform database (metadata store): SQLite or PostgreSQL for the platform's own state, migration infrastructure (`make migrate`), `databases` table with id, name, owner_team, purpose, namespace, cluster_name, pooler_name, status, connection details, timestamps, soft delete
- [ ] CNPG Cluster template: built-in Go template generating a CNPG `Cluster` resource, configurable instances/storage/PG version, naming `daap-{database-name}`
- [ ] PgBouncer Pooler template: built-in Go template for CNPG `Pooler` resource, type `rw`, pool mode `transaction`, references Cluster, naming `daap-{database-name}-pooler`
- [ ] Create Database endpoint (`POST /databases`): accepts name, owner_team, purpose, optional instances/storage_size; validates input; creates CNPG Cluster + Pooler on K8s; stores metadata with status `provisioning`; returns 201
- [ ] Provisioning status reconciliation: background watcher/poller monitoring CNPG Cluster status; on Ready reads credentials from K8s Secret, stores connection details, updates to `ready`; on failure updates to `error`
- [ ] Credential retrieval: reads auto-generated K8s Secret (`{cluster-name}-app`), constructs connection string from Pooler service endpoint + credentials
- [ ] List databases endpoint (`GET /databases`): paginated, filterable by owner_team/status/name, excludes soft-deleted by default, connection details only for `ready` databases
- [ ] Get database endpoint (`GET /databases/:id`): returns full database record including connection details if ready, 404 for not found or soft-deleted
- [ ] Update database endpoint (`PATCH /databases/:id`): updatable fields owner_team and purpose, name immutable, ownership required
- [ ] Delete database endpoint (`DELETE /databases/:id`): deletes CNPG Cluster + Pooler from K8s, soft-deletes metadata, subsequent GET returns 404
- [ ] Input validation: database name lowercase alphanumeric + hyphens, 3-63 chars, starts with letter; required fields enforced; 400 with field-specific errors
- [ ] Integration tests: tests against local K8s + CNPG operator, full lifecycle (create -> ready -> get -> update -> delete), `make test-integration` passes, 80% coverage on database module

## Non-Goals
- No lifecycle states beyond provisioning/ready/error/deleting/deleted
- No authentication/authorization
- No database movement between clusters
- No backup management
- No monitoring/metrics

## Dependencies
- v0.1 foundation (Go project, K8s client, dev environment, API skeleton)
- CNPG operator running on local K8s cluster
- Platform database (SQLite or PostgreSQL — decided via ADR)

## Acceptance Criteria
- `make migrate` creates the `databases` table, rollback drops it
- `POST /databases` creates CNPG Cluster + Pooler on K8s and returns 201
- Database transitions from `provisioning` to `ready` once CNPG Cluster is healthy
- Connection details (host, port, dbname, user, password) available when database is ready
- `GET /databases` returns paginated, filterable list excluding soft-deleted
- `GET /databases/:id` returns full record with connection details
- `PATCH /databases/:id` allows partial update, enforces ownership
- `DELETE /databases/:id` cleans up K8s resources and soft-deletes metadata
- Invalid input returns 400 with specific field errors
- `make test-integration` passes with 80% coverage on database module
