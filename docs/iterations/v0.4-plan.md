# Technical Plan — v0.4

## Task Order

### Phase 1: Design

| # | Task | Owner | Complexity | Depends On |
|---|------|-------|-----------|-----------|
| 1 | ADR 006: Auth strategy (bcrypt, key format, user model, middleware stack, superuser bootstrap) | architect | M | — |

### Phase 2: Infrastructure & Data Layer

| # | Task | Owner | Complexity | Depends On |
|---|------|-------|-----------|-----------|
| 2 | Migrations: `004_create_teams` and `005_create_users` tables | dev | S | 1 |
| 3 | Team package: model, repository interface, pgx implementation, sentinel errors | dev | M | 2 |
| 4 | Auth package: user model, identity, repository interface, pgx implementation, sentinel errors | dev | M | 2 |
| 5 | Auth service: key generation (bcrypt), authentication, superuser bootstrap | dev | M | 3, 4 |
| 6 | Config: add `BcryptCost` env var, update `.env.example` | dev | S | 1 |

### Phase 3: Middleware

| # | Task | Owner | Complexity | Depends On |
|---|------|-------|-----------|-----------|
| 7 | Authentication middleware: extract `X-API-Key`, resolve to Identity, store in context | dev | M | 5 |
| 8 | Authorization middleware: `RequireSuperuser()` and `RequireRole()` factories | dev | S | 7 |

### Phase 4: Handlers & Router

| # | Task | Owner | Complexity | Depends On |
|---|------|-------|-----------|-----------|
| 9 | Team validation + handler: `POST /teams`, `GET /teams`, `DELETE /teams/{id}` | dev | M | 3, 8 |
| 10 | User validation + handler: `POST /users`, `GET /users`, `DELETE /users/{id}` | dev | M | 5, 8 |
| 11 | Router restructure: public group, superuser group, business group with middleware | dev | M | 7, 8, 9, 10 |
| 12 | Ownership scoping on database endpoints (all 5 handlers) | dev | M | 7, 8 |
| 13 | Superuser bootstrap in `main.go` | dev | S | 5, 11 |

### Phase 5: OpenAPI & Documentation

| # | Task | Owner | Complexity | Depends On |
|---|------|-------|-----------|-----------|
| 14 | Update OpenAPI spec: security scheme, 6 new paths, new schemas, new error codes, 401/403 on all auth'd endpoints | dev | L | 9, 10, 11, 12 |
| 15 | README.md update: auth model, bootstrap, endpoints | dev | S | 14 |
| 16 | Rule file: `.claude/rules/auth.md` | dev | S | 12, 14 |

### Phase 6: Tests

| # | Task | Owner | Complexity | Depends On |
|---|------|-------|-----------|-----------|
| 17 | Unit tests: team repository | dev | S | 3 |
| 18 | Unit tests: auth service + user repository | dev | M | 5 |
| 19 | Unit tests: auth middleware + authz middleware | dev | M | 7, 8 |
| 20 | Unit tests: team handler | dev | M | 9 |
| 21 | Unit tests: user handler | dev | M | 10 |
| 22 | Unit tests: ownership scoping in database handler | dev | M | 12 |
| 23 | Update existing integration tests to be auth-aware | dev | M | 11, 13 |
| 24 | Integration tests: auth lifecycle + database ownership | dev | L | 13, 14 |

### Phase 7: Review

| # | Task | Owner | Complexity | Depends On |
|---|------|-------|-----------|-----------|
| 25 | Code review: all v0.4 PRs | reviewer | L | 17–24 |

## Task Details

### Task 1: ADR 006 — Auth Strategy
Write `docs/architecture/decisions/006-auth-strategy.md`. Decide on:
- API key hashing: bcrypt (cost=12) over argon2id — simpler in Go, sufficient for high-entropy keys
- Key format: `daap_` prefix + 32 random bytes → base64url (total ~47 chars); prefix = first 8 chars for DB lookup
- User model: superuser (teamless, bootstrapped on first run) + teams (name + role) + users (name + team FK + key)
- Auth header: `X-API-Key`
- Middleware stack order: RequestID → Recovery → Auth → AuthZ → Logger → handler
- Authorization matrix: superuser → team/user management only; platform role → all business; product role → own team's business
- Superuser bootstrap: auto-created when `users` table is empty on startup; key logged once

### Task 2: Migrations
Create two migration files following existing `NNN_description.{up,down}.sql` pattern:
- `migrations/004_create_teams.up.sql` / `.down.sql` — teams table with name unique, role check constraint
- `migrations/005_create_users.up.sql` / `.down.sql` — users table with FK to teams, partial unique index on is_superuser, partial index on api_key_prefix

### Task 3: Team Package
Create `internal/team/` package:
- `model.go`: `Team` struct (ID, Name, Role, CreatedAt, UpdatedAt)
- `repository.go`: `Repository` interface (Create, GetByID, List, Delete) + sentinel errors (ErrTeamNotFound, ErrDuplicateTeamName, ErrTeamHasUsers)
- `postgres_repository.go`: pgx implementation using pgxpool. Delete maps FK RESTRICT PG error (`23503`) to `ErrTeamHasUsers`. Create maps unique violation (`23505`) to `ErrDuplicateTeamName`.

### Task 4: Auth Package — User Model & Repository
Create `internal/auth/` package:
- `model.go`: `User` struct (ID, Name, TeamID, IsSuperuser, ApiKeyPrefix, ApiKeyHash, CreatedAt, RevokedAt) + `Identity` struct (UserID, UserName, TeamID, TeamName, Role, IsSuperuser)
- `repository.go`: `UserRepository` interface (Create, GetByID, FindByPrefix, List, Revoke, CountAll) + sentinel errors (ErrUserNotFound, ErrUserRevoked)
- `postgres_repository.go`: pgx implementation. FindByPrefix queries `WHERE api_key_prefix = $1 AND revoked_at IS NULL`. List joins with teams to include team name and role.

### Task 5: Auth Service
Create `internal/auth/service.go`:
- `GenerateKey()`: `crypto/rand` → 32 bytes → base64url → prepend `daap_` → prefix first 8 chars → `bcrypt.GenerateFromPassword(key, cost)`
- `Authenticate(ctx, rawKey)`: extract prefix → `FindByPrefix` → iterate candidates → `bcrypt.CompareHashAndPassword` → if match, fetch team via teamRepo → build Identity
- `BootstrapSuperuser(ctx)`: if `CountAll() == 0`, generate key, create superuser user (team_id=nil, is_superuser=true), return rawKey

### Task 6: Config Update
Add `BcryptCost int` to Config struct with `envconfig:"BCRYPT_COST" default:"12"`. Add `BCRYPT_COST=12` to `.env.example`.

### Task 7: Authentication Middleware
Create `internal/api/middleware/auth.go`:
- `Auth(authService *auth.Service) func(http.Handler) http.Handler`
- Extract `X-API-Key` header. If empty → 401 UNAUTHORIZED.
- Call `authService.Authenticate(rawKey)`. If error → 401 UNAUTHORIZED.
- Store `*Identity` in context. Helper `GetIdentity(ctx) *Identity`.

### Task 8: Authorization Middleware
Create `internal/api/middleware/authz.go`:
- `RequireSuperuser() func(http.Handler) http.Handler` — reads Identity from context, rejects if `!identity.IsSuperuser` → 403 FORBIDDEN
- `RequireRole(roles ...string) func(http.Handler) http.Handler` — rejects superuser (no role), rejects if identity's team role not in allowed roles → 403 FORBIDDEN

### Task 9: Team Handler
Create `internal/api/handler/team.go` + `internal/api/validation/team.go`:
- Validation: `name` required (max 255), `role` required and in `["platform","product"]`
- `POST /teams`: validate → repo.Create → 201 with team response
- `GET /teams`: repo.List → 200 with list envelope (total, page=1, limit=100)
- `DELETE /teams/{id}`: parse UUID → repo.Delete → 204 or 409 TEAM_HAS_USERS

### Task 10: User Handler
Create `internal/api/handler/user.go` + `internal/api/validation/user.go`:
- Validation: `name` required (max 255), `teamId` required and valid UUID
- `POST /users`: validate → verify team exists → generate key → repo.Create → 201 with raw key in response
- `GET /users`: repo.List → 200 with list envelope (metadata only, never key/hash)
- `DELETE /users/{id}`: check not superuser → repo.Revoke → 204 or 403 if superuser

### Task 11: Router Restructure
Rewrite `internal/api/router.go`:
- Add `AuthService`, `TeamRepo`, `UserRepo` to `RouterDeps`
- Public group: `/health`, `/openapi.json` (no middleware)
- Authenticated group (use `Auth(authService)` middleware):
  - Superuser sub-group (use `RequireSuperuser()`): `/teams` + `/users` routes
  - Business sub-group (use `RequireRole("platform","product")`): `/databases` routes

### Task 12: Ownership Scoping
Modify `internal/api/handler/database.go`:
- Add helper `checkOwnership(identity *Identity, ownerTeam string) error`
- `POST /databases`: product users must match ownerTeam or auto-set; platform users can set any
- `GET /databases`: product users get forced `owner_team` filter
- `GET/PATCH/DELETE /databases/{id}`: product users get 404 for non-owned databases
- `PATCH`: product users cannot change `ownerTeam` field

### Task 13: Superuser Bootstrap
Modify `cmd/server/main.go`:
- After DB pool init: create team repository, user repository, auth service
- Call `authService.BootstrapSuperuser(ctx)` — if returns key, log it; if no-op, continue
- Pass auth service + repositories to RouterDeps

### Task 14: OpenAPI Spec Update
Update `api/openapi.yaml`:
- Add `securitySchemes.ApiKeyAuth` (type: apiKey, in: header, name: X-API-Key)
- Add global `security: [{ApiKeyAuth: []}]`
- Override `/health` and `/openapi.json` with `security: []`
- Add 6 new paths: POST/GET /teams, DELETE /teams/{id}, POST/GET /users, DELETE /users/{id}
- Add schemas: Team, CreateTeamRequest, TeamResponse, TeamListResponse, User, UserWithApiKey, CreateUserRequest, UserResponse, UserWithApiKeyResponse, UserListResponse
- Add error codes: UNAUTHORIZED, FORBIDDEN, TEAM_HAS_USERS
- Add 401/403 responses to all authenticated endpoints

### Task 15: README Update
Add Authentication section: domain model, bootstrap process, X-API-Key header, roles, new endpoints.

### Task 16: Auth Rule File
Create `.claude/rules/auth.md` with conventions for: middleware usage, Identity context access, ownership scoping pattern, superuser constraints, key handling (never log/store plaintext beyond bootstrap).

### Tasks 17–24: Tests
Follow existing patterns:
- Unit tests in `tests/unit/` hierarchy (not colocated)
- Mock interfaces for handler tests (same pattern as `database_handler_test.go`)
- Real DB for repository tests (same pattern as `repository_test.go` with `setupRepo` helper)
- Integration tests in `tests/integration/api/` (same pattern as `database_test.go`)
- Table-driven tests, testify assertions, `t.Run()` subtests

## Dependency Graph

```
Task 1 (ADR)
├── Task 2 (migrations)
│   ├── Task 3 (team pkg) ──── Task 17 (team repo tests)
│   │   ├── Task 5 (auth service) ──── Task 18 (auth svc tests)
│   │   │   ├── Task 7 (auth mw) ──── Task 19 (mw tests)
│   │   │   │   ├── Task 8 (authz mw)
│   │   │   │   │   ├── Task 9 (team handler) ──── Task 20 (team handler tests)
│   │   │   │   │   ├── Task 10 (user handler) ──── Task 21 (user handler tests)
│   │   │   │   │   ├── Task 12 (ownership) ──── Task 22 (ownership tests)
│   │   │   │   │   └── Task 11 (router) ──┐
│   │   │   │   │       └── Task 13 (bootstrap) ──┤
│   │   │   │   │                                  ├── Task 23 (update existing tests)
│   │   │   │   │                                  └── Task 24 (integration tests)
│   │   │   │   │
│   │   │   │   └── Task 14 (OpenAPI) ── Task 15 (README)
│   │   │   │                         └── Task 16 (auth rule)
│   └── Task 4 (auth pkg) ── (feeds into Task 5)
│
└── Task 6 (config)
                                                          └── Task 25 (review)
```

**Critical path**: 1 → 2 → 3 → 5 → 7 → 8 → 11 → 13 → 24 → 25 (10 tasks deep)

## PR Strategy

Given the branch-per-task workflow, v0.4 should be delivered as **multiple sequential PRs** merged to `master`:

| PR | Tasks | Branch | Description |
|----|-------|--------|-------------|
| PR A | 1 | `docs/auth-strategy-adr` | ADR 006 only |
| PR B | 2, 3, 4, 5, 6, 17, 18 | `feat/auth-data-layer` | Migrations + team pkg + auth pkg + service + unit tests |
| PR C | 7, 8, 19 | `feat/auth-middleware` | Auth + authz middleware + unit tests |
| PR D | 9, 10, 11, 12, 13, 20, 21, 22 | `feat/auth-handlers-router` | Handlers + router restructure + ownership scoping + unit tests |
| PR E | 14, 15, 16 | `chore/auth-openapi-docs` | OpenAPI spec + README + auth rule |
| PR F | 23, 24 | `test/auth-integration` | Updated integration tests + new auth integration tests |

Each PR is reviewed (task 25) before merge. PRs are sequential — each depends on the previous being merged.

## Open Questions

None — ADR 006 (task 1) resolves all open design decisions.

## Risks

| Risk | Mitigation |
|------|-----------|
| bcrypt is slow by design (cost=12 ≈ 200ms per comparison) — could impact request latency | Prefix-based lookup narrows candidates to 1 in practice (8-char prefix from base64url is near-unique). Worst case: 2–3 comparisons. Monitor with request logging. |
| Superuser key is logged once at startup — could be missed in noisy logs | Log at `WARN` level with clear "SAVE THIS KEY" message. Key format (`daap_...`) is easily grep-able. |
| Existing integration tests break until auth-aware | PR F (test updates) must be the last PR. During development, run `make test` (unit only) for intermediate PRs; integration tests pass after PR F. |
| Router restructure (task 11) touches all existing routes | Existing unit tests for handlers don't go through the router; they test handlers directly. Route coverage test will catch any mismatches. |

## Summary

| Metric | Value |
|--------|-------|
| Total tasks | 25 |
| architect | 1 task (ADR) |
| dev | 23 tasks (everything else) |
| reviewer | 1 task (review all PRs) |
| local-devops | 0 tasks (no infra changes needed) |
| PRs | 6 sequential PRs |
| Critical path depth | 10 tasks |
| New files | ~18 (2 migrations, 8 Go packages, 2 validations, 2 handlers, 2 middleware, 1 rule, 1 ADR) |
| Modified files | ~7 (router, database handler, main.go, config, .env.example, openapi.yaml, README) |
