# Iteration v0.2 — Technical Task Plan

## Summary

v0.2 delivers the full database lifecycle: create a database (provisions CNPG Cluster + PgBouncer Pooler on Kubernetes), list/get/update/delete databases, retrieve connection details and credentials. A platform database (**PostgreSQL**) stores metadata and tracks provisioning state.

**24 tasks** across 5 phases, assigned to 4 agents.

---

## Phase 1 — Architecture Decisions (architect)

| # | Task | GitHub Issue | Agent | Complexity | Depends On |
|---|------|-------------|-------|------------|------------|
| 1 | ADR 002: Platform database choice (PostgreSQL with pgx driver) | #37 | architect | M | — |
| 2 | Database schema design: `databases` table DDL, migration file naming, index strategy | #38 | architect | M | #37 |
| 3 | OpenAPI spec: all database endpoints (POST, GET list, GET single, PATCH, DELETE) | #26 | architect | L | #37 |

## Phase 2 — Infrastructure (local-devops)

| # | Task | GitHub Issue | Agent | Complexity | Depends On |
|---|------|-------------|-------|------------|------------|
| 4 | Add PostgreSQL container to docker-compose and CI | #46 | local-devops | M | — |
| 5 | Migration infrastructure: golang-migrate with PostgreSQL driver, `make migrate` | #39 | local-devops | M | #37, #38, #46 |
| 6 | Update cluster-setup.sh to auto-install CNPG operator on k3d cluster | #40 | local-devops | S | — |
| 7 | Seed data script (`make seed`) for sample databases in platform DB | #25 | local-devops | S | #39 |

## Phase 3 — Core Implementation (implementer)

| # | Task | GitHub Issue | Agent | Complexity | Depends On |
|---|------|-------------|-------|------------|------------|
| 8 | Platform database layer: pgx/pgxpool driver, connection management, health check | #13 | implementer | L | #37, #38, #39, #46 |
| 9 | Database repository: CRUD operations on `databases` table | #41 | implementer | M | #8 (task 8) |
| 10 | CNPG Cluster template: Go builder generating unstructured Cluster resource | #14 | implementer | M | #38 |
| 11 | PgBouncer Pooler template: Go builder generating unstructured Pooler resource | #15 | implementer | S | #10 (task 10) |
| 12 | K8s resource manager: apply/delete Cluster+Pooler, read Secrets | #42 | implementer | M | #10, #11 |
| 13 | Create database endpoint (POST /databases) | #16 | implementer | L | #9, #12 |
| 14 | Input validation module: name rules, required fields, field-specific 400 errors | #23 | implementer | M | #13 |
| 15 | Provisioning status reconciliation: background goroutine polling CNPG Cluster status | #17 | implementer | L | #12, #9 |
| 16 | Credential retrieval: read `{cluster-name}-app` Secret, build connection string from Pooler | #18 | implementer | M | #12, #15 |
| 17 | List databases endpoint (GET /databases) with pagination + filters | #19 | implementer | M | #9 |
| 18 | Get database endpoint (GET /databases/:id) with connection details if ready | #20 | implementer | S | #9, #16 |
| 19 | Update database endpoint (PATCH /databases/:id) | #21 | implementer | S | #9 |
| 20 | Delete database endpoint (DELETE /databases/:id): K8s cleanup + soft delete | #22 | implementer | M | #9, #12 |

## Phase 4 — Testing (qa)

| # | Task | GitHub Issue | Agent | Complexity | Depends On |
|---|------|-------------|-------|------------|------------|
| 21 | Unit tests: database repository (real PostgreSQL via docker-compose) | #43 | qa | M | #9 |
| 22 | Unit tests: CNPG/Pooler templates, K8s resource manager (mocked client) | #44 | qa | M | #10, #11, #12 |
| 23 | Unit tests: all database handlers + validation + reconciliation | #45 | qa | L | #13–#20 |
| 24 | Integration tests: full database lifecycle on k3d + CNPG + PostgreSQL | #24 | qa | L | #21, #22, #23, #6 |

---

## Dependency Graph

```
Phase 1 (architect)
  #37 ADR 002 (PostgreSQL) ────────────┐
  #38 Schema design ◄── #37            │
  #26 OpenAPI spec ◄── #37             │
                                       │
Phase 2 (local-devops)                 │
  #46 PostgreSQL in docker-compose/CI  │  (independent — starts immediately)
  #40 CNPG on k3d                      │  (independent — starts immediately)
  #39 Migration infra ◄── #37, #38, #46
  #25 Seed script ◄── #39             │
                                       │
Phase 3 (implementer)                  │
  #13 DB layer (pgx) ◄── #37, #38, #39, #46
  #41 DB repository ◄── #13           │
  #14 Cluster template ◄── #38        │
  #15 Pooler template ◄── #14         │
  #42 K8s resource mgr ◄── #14, #15   │
  #16 POST /databases ◄── #41, #42    │
  #23 Validation ◄── #16              │
  #17 Reconciliation ◄── #42, #41     │
  #18 Credentials ◄── #42, #17        │
  #19 GET list ◄── #41                │
  #20 GET single ◄── #41, #18         │
  #21 PATCH ◄── #41                   │
  #22 DELETE ◄── #41, #42             │
                                       │
Phase 4 (qa)                           │
  #43 Unit: repository ◄── #41 (real PG)
  #44 Unit: K8s templates ◄── #42     │
  #45 Unit: handlers ◄── all handlers │
  #24 Integration ◄── #43, #44, #45, #40
```

## Execution Strategy

1. **Local-devops starts immediately** with PostgreSQL container (#46) and CNPG-on-k3d (#40) — both have no dependencies.
2. **Architect starts immediately** with ADR 002 (#37). Schema design (#38) and OpenAPI (#26) follow once #37 is done.
3. **Local-devops picks up migration infra** (#39) once schema design (#38) and PG container (#46) are both ready.
4. **Implementer starts** once migration infra is ready. Begins with DB layer (pgx) + repository, then CNPG templates (can start once schema is done). POST endpoint ties them together.
5. **QA writes unit tests** as each module is delivered. Repository tests run against real PostgreSQL (docker-compose). Integration tests run last, requiring k3d CNPG setup + all unit tests passing.
6. **Seed script** can be done anytime after migration infra exists.

## Agent Assignments Summary

| Agent | Tasks | Count |
|-------|-------|-------|
| architect | #37, #38, #26 | 3 |
| local-devops | #46, #39, #40, #25 | 4 |
| implementer | #13, #41, #14, #15, #42, #16, #23, #17, #18, #19, #20, #21, #22 | 13 |
| qa | #43, #44, #45, #24 | 4 |
| **Total** | | **24** |

## All GitHub Issues

| Issue | Title | Agent | Complexity | Status |
|-------|-------|-------|------------|--------|
| #37 | ADR 002: Platform database (PostgreSQL) | architect | M | ready |
| #38 | Database schema design (databases table, migrations) | architect | M | blocked |
| #26 | OpenAPI spec for all database endpoints | architect | L | blocked |
| #46 | Add PostgreSQL container to docker-compose and CI | local-devops | M | ready |
| #39 | Migration infrastructure (golang-migrate, make migrate) | local-devops | M | blocked |
| #40 | Auto-install CNPG operator in cluster-setup.sh | local-devops | S | ready |
| #25 | Seed data script (make seed) | local-devops | S | blocked |
| #13 | Platform database layer (pgx/pgxpool) | implementer | L | blocked |
| #41 | Database repository (CRUD on databases table) | implementer | M | blocked |
| #14 | CNPG Cluster template | implementer | M | blocked |
| #15 | PgBouncer Pooler template | implementer | S | blocked |
| #42 | K8s resource manager | implementer | M | blocked |
| #16 | Create database endpoint (POST /databases) | implementer | L | blocked |
| #23 | Input validation | implementer | M | blocked |
| #17 | Provisioning status reconciliation | implementer | L | blocked |
| #18 | Credential retrieval | implementer | M | blocked |
| #19 | List databases (GET /databases) | implementer | M | blocked |
| #20 | Get database (GET /databases/:id) | implementer | S | blocked |
| #21 | Update database (PATCH /databases/:id) | implementer | S | blocked |
| #22 | Delete database (DELETE /databases/:id) | implementer | M | blocked |
| #43 | Unit tests: database repository | qa | M | blocked |
| #44 | Unit tests: CNPG templates + K8s resource manager | qa | M | blocked |
| #45 | Unit tests: database handlers + validation + reconciliation | qa | L | blocked |
| #24 | Integration tests: full database lifecycle | qa | L | blocked |
