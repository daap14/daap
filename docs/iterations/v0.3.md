# Iteration v0.3 — OpenAPI Specification

## Goal
Establish an OpenAPI 3.1 specification for all existing endpoints, served as JSON at runtime and validated in CI, to provide a machine-readable API contract.

## Features
- [ ] Corrected OpenAPI 3.1 spec at `api/openapi.yaml` covering all 6 endpoints (health, database CRUD), fixing every discrepancy in the draft:
  - snake_case to camelCase for all JSON field names (`ownerTeam`, `clusterName`, `poolerName`, `secretName`, `createdAt`, `updatedAt`, `requestId`)
  - Remove `ConnectionDetails` schema (with `dbname`, `username`, `password`); replace with `secretName` field (K8s Secret reference)
  - Remove `instances` and `storageSize` from `CreateDatabaseRequest` (removed in ADR 004)
  - Add `namespace` to `CreateDatabaseRequest` (accepted by the handler)
  - Change error code `CONFLICT` to `DUPLICATE_NAME` for duplicate database names
  - Add `database` status to health endpoint (`HealthData` schema)
  - Add missing error response codes: 400 on GET/DELETE for invalid UUID, 422 on PATCH for empty body
- [ ] `GET /openapi.json` endpoint: embed `api/openapi.yaml` via Go `embed`, convert to JSON with `sigs.k8s.io/yaml`, serve with `application/json` content type
- [ ] Route coverage test: compares spec paths+methods against registered Chi routes, fails on mismatch (catches structural drift)
- [ ] `make lint-openapi` target: runs `vacuum lint api/openapi.yaml` with a ruleset that enforces descriptions, valid schemas, and no unused components
- [ ] CI job: adds `lint-openapi` step to the GitHub Actions workflow, runs after `lint` and before `test`
- [ ] `.claude/rules/openapi.md`: rule requiring spec updates alongside any API handler changes
- [ ] `README.md` update: document `GET /openapi.json` endpoint and `make lint-openapi` command

## Spec Corrections Summary

| Draft (incorrect) | Actual code | Fix |
|--------------------|-------------|-----|
| `owner_team` | `ownerTeam` | camelCase all field names |
| `cluster_name` | `clusterName` | camelCase |
| `pooler_name` | `poolerName` | camelCase |
| `created_at` | `createdAt` | camelCase |
| `updated_at` | `updatedAt` | camelCase |
| `ConnectionDetails` with `host`, `port`, `dbname`, `username`, `password` | `host`, `port`, `secretName` (K8s Secret ref) | Remove `ConnectionDetails`; use flat fields with `secretName` |
| `instances` in `CreateDatabaseRequest` | Not accepted | Remove field |
| `storageSize` in `CreateDatabaseRequest` | Not accepted | Remove field |
| No `namespace` in `CreateDatabaseRequest` | Accepted by handler | Add field |
| Error code `CONFLICT` | `DUPLICATE_NAME` | Fix code value |
| No `database` in `HealthData` | `database: {connected: bool}` | Add field |

## Non-Goals
- Swagger UI hosting or interactive documentation
- Client SDK generation from the spec
- Authentication on `GET /openapi.json`
- Response-body validation tests (field-level drift detection)
- Changing the actual API behavior — this iteration only documents what exists

## Dependencies
- v0.2 codebase (all 6 endpoints implemented and tested)
- ADR 005 (OpenAPI tooling decision)
- `sigs.k8s.io/yaml` (indirect dep, promoted to direct)
- `vacuum` CLI for linting (installed in CI and dev)

## Acceptance Criteria
- `make build` succeeds with the new `embed` directive and `sigs.k8s.io/yaml` import
- `make test` passes, including the new route coverage test
- `make lint-openapi` passes with zero errors on `api/openapi.yaml`
- `curl http://localhost:8080/openapi.json` returns a valid JSON document matching the YAML spec
- CI pipeline passes with the new `lint-openapi` job
- All field names in the spec match the actual JSON serialization (camelCase)
- No infrastructure parameters (`instances`, `storageSize`, `dbname`, `username`, `password`) appear in the spec
