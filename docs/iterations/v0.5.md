# Iteration v0.5 — Tier System

## Goal
Replace hardcoded infrastructure defaults with a platform-managed tier system, so platform teams define named infrastructure profiles and product teams create databases by selecting a tier.

## Domain Model

```
Tier
  ├── name: string (unique, DNS-compatible)
  ├── description: string (human-readable, shown to product teams)
  ├── instances: int (CNPG cluster replicas, 1–10)
  ├── cpu: string (K8s resource format, e.g., "500m", "2")
  ├── memory: string (K8s resource format, e.g., "512Mi", "4Gi")
  ├── storage_size: string (K8s resource format, e.g., "1Gi", "100Gi")
  ├── storage_class: string (K8s StorageClass name, optional)
  ├── pg_version: string (e.g., "16", "17")
  ├── pool_mode: string ("transaction" | "session" | "statement")
  ├── max_connections: int (PgBouncer max connections, 10–10000)
  └── has many Databases

Database (extended)
  ├── tier_id: FK → tiers.id (required for new databases)
  ├── tier_name: string (transient, via JOIN — for API responses)
  └── ... existing fields unchanged
```

### Authorization matrix (updated)

| Caller | `/tiers` mutations | `GET /tiers` | `/databases` | `/teams`, `/users` |
|--------|-------------------|-------------|--------------|-------------------|
| **Superuser** | No access (403) | No access (403) | No access (403) | Full CRUD |
| **Platform user** | Full CRUD | Full view (all fields) | Full access (all databases) | No access (403) |
| **Product user** | No access (403) | Read-only (description only) | Own team's databases only | No access (403) |
| **Unauthenticated** | 401 | 401 | 401 | 401 |

Key design decisions:
- Tier mutations are restricted to platform-role users via `RequireRole("platform")`
- `GET /tiers` and `GET /tiers/{id}` are available to all authenticated business users (`RequireRole("platform", "product")`)
- Product users see a **redacted view**: only `id`, `name`, `description` — no infrastructure parameters
- The superuser cannot access tier endpoints (blocked by `RequireRole`, same as databases)

## Features

- [ ] **ADR 007 — Tier system**: Write `docs/architecture/decisions/007-tier-system.md`
  - Tiers replace hardcoded defaults from ADR 004 (`defaultInstances=1`, `defaultStorageSize=1Gi`, `defaultPGVersion="16"` in `internal/k8s/template/cluster.go`)
  - Tier is required at database creation; no default tier (platform must configure at least one before any database can be created)
  - Tier parameters are immutable on existing databases — changing a tier does not retroactively affect databases already using it
  - `destruction_strategy` and `backup_enabled` are tier columns but have no runtime effect until v0.6/v0.8 — they are stored and returned, not enforced
  - Product teams see only `id`, `name`, `description` (not infrastructure parameters)

- [ ] **Migration `008_create_tiers.sql`**: New `tiers` table
  - ```sql
    -- up
    CREATE TABLE tiers (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        name VARCHAR(63) NOT NULL UNIQUE,
        description TEXT NOT NULL DEFAULT '',
        instances INT NOT NULL DEFAULT 1,
        cpu VARCHAR(20) NOT NULL DEFAULT '500m',
        memory VARCHAR(20) NOT NULL DEFAULT '512Mi',
        storage_size VARCHAR(20) NOT NULL DEFAULT '1Gi',
        storage_class VARCHAR(255) NOT NULL DEFAULT '',
        pg_version VARCHAR(10) NOT NULL DEFAULT '16',
        pool_mode VARCHAR(20) NOT NULL DEFAULT 'transaction'
            CHECK (pool_mode IN ('transaction', 'session', 'statement')),
        max_connections INT NOT NULL DEFAULT 100,
        destruction_strategy VARCHAR(20) NOT NULL DEFAULT 'hard_delete'
            CHECK (destruction_strategy IN ('freeze', 'archive', 'hard_delete')),
        backup_enabled BOOLEAN NOT NULL DEFAULT FALSE,
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    CREATE INDEX idx_tiers_name ON tiers (name);

    -- down
    DROP TABLE IF EXISTS tiers;
    ```
  - `name` uses the same DNS-compatible naming pattern as databases (lowercase alphanumeric + hyphens, 3–63 chars)
  - `instances` CHECK: `instances >= 1 AND instances <= 10`
  - `max_connections` CHECK: `max_connections >= 10 AND max_connections <= 10000`
  - `storage_class` defaults to empty string (use cluster default); non-empty value sets explicit StorageClass
  - `destruction_strategy` and `backup_enabled` are stored but not enforced until v0.6/v0.8

- [ ] **Migration `009_add_tier_id_to_databases.sql`**: Add tier FK to databases
  - ```sql
    -- up
    ALTER TABLE databases
        ADD COLUMN tier_id UUID REFERENCES tiers(id) ON DELETE RESTRICT;

    CREATE INDEX idx_databases_tier_id ON databases (tier_id);

    -- down
    DROP INDEX IF EXISTS idx_databases_tier_id;
    ALTER TABLE databases DROP COLUMN IF EXISTS tier_id;
    ```
  - `tier_id` is nullable at DB level — existing databases created before v0.5 will have `NULL` tier_id
  - Application enforces `tier_id` as required for all new `POST /databases` requests
  - `ON DELETE RESTRICT` — cannot delete a tier that has active (non-deleted) databases

- [ ] **Tier model and repository**: `internal/tier/`
  - `model.go`:
    ```go
    type Tier struct {
        ID                  uuid.UUID
        Name                string
        Description         string
        Instances           int
        CPU                 string
        Memory              string
        StorageSize         string
        StorageClass        string
        PGVersion           string
        PoolMode            string
        MaxConnections      int
        DestructionStrategy string
        BackupEnabled       bool
        CreatedAt           time.Time
        UpdatedAt           time.Time
    }

    type UpdateFields struct {
        Description         *string
        Instances           *int
        CPU                 *string
        Memory              *string
        StorageSize         *string
        StorageClass        *string
        PGVersion           *string
        PoolMode            *string
        MaxConnections      *int
        DestructionStrategy *string
        BackupEnabled       *bool
    }
    ```
  - `repository.go` — interface:
    ```go
    type Repository interface {
        Create(ctx context.Context, tier *Tier) error
        GetByID(ctx context.Context, id uuid.UUID) (*Tier, error)
        GetByName(ctx context.Context, name string) (*Tier, error)
        List(ctx context.Context) ([]Tier, error)
        Update(ctx context.Context, id uuid.UUID, fields UpdateFields) (*Tier, error)
        Delete(ctx context.Context, id uuid.UUID) error
    }
    ```
  - Sentinel errors: `ErrTierNotFound`, `ErrDuplicateTierName`, `ErrTierHasDatabases`
  - `postgres_repository.go` — pgx implementation
  - `Delete` maps FK violation (PG error code `23503`) to `ErrTierHasDatabases`
  - `Create` maps unique violation (PG error code `23505`) to `ErrDuplicateTierName`

- [ ] **Tier handler**: `internal/api/handler/tier.go`
  - `POST /tiers` — create a tier (platform-team only)
    - Request body:
      ```json
      {
        "name": "standard",
        "description": "Standard tier for dev databases",
        "instances": 1,
        "cpu": "500m",
        "memory": "512Mi",
        "storageSize": "1Gi",
        "storageClass": "",
        "pgVersion": "16",
        "poolMode": "transaction",
        "maxConnections": 100,
        "destructionStrategy": "hard_delete",
        "backupEnabled": false
      }
      ```
    - Validates all fields (see validation section below)
    - Returns 201: `{"data": {...tier...}, ...}` with all fields
    - Error codes: `VALIDATION_ERROR` (400), `DUPLICATE_NAME` (409)

  - `GET /tiers` — list all tiers (all authenticated business users)
    - Returns 200 with list envelope (no pagination — tier count expected to be small)
    - **Platform users**: full response with all infrastructure fields
    - **Product users**: redacted response — only `id`, `name`, `description`
    - Response uses list envelope: `{"data": [...], "meta": {"total": N, "page": 1, "limit": 100, ...}}`

  - `GET /tiers/{id}` — get a single tier (all authenticated business users)
    - Returns 200 with tier data
    - **Platform users**: full response with all infrastructure fields
    - **Product users**: redacted response — only `id`, `name`, `description`
    - Error codes: `INVALID_ID` (400), `NOT_FOUND` (404)

  - `PATCH /tiers/{id}` — update a tier (platform-team only)
    - Request body: any subset of fields (same as create, all optional); `name` is immutable
    - Returns 200 with updated tier
    - Error codes: `INVALID_ID` (400), `INVALID_JSON` (400), `VALIDATION_ERROR` (400), `IMMUTABLE_FIELD` (400), `NOT_FOUND` (404)

  - `DELETE /tiers/{id}` — delete a tier (platform-team only)
    - Fails if tier has active (non-deleted) databases → 409 `TIER_HAS_DATABASES`
    - Returns 204 on success
    - Error codes: `INVALID_ID` (400), `NOT_FOUND` (404), `TIER_HAS_DATABASES` (409)

  - Handler struct:
    ```go
    type TierHandler struct {
        repo tier.Repository
    }

    func NewTierHandler(repo tier.Repository) *TierHandler
    ```

  - Response structs:
    ```go
    // Full response (platform users)
    type tierResponse struct {
        ID                  string `json:"id"`
        Name                string `json:"name"`
        Description         string `json:"description"`
        Instances           int    `json:"instances"`
        CPU                 string `json:"cpu"`
        Memory              string `json:"memory"`
        StorageSize         string `json:"storageSize"`
        StorageClass        string `json:"storageClass"`
        PGVersion           string `json:"pgVersion"`
        PoolMode            string `json:"poolMode"`
        MaxConnections      int    `json:"maxConnections"`
        DestructionStrategy string `json:"destructionStrategy"`
        BackupEnabled       bool   `json:"backupEnabled"`
        CreatedAt           string `json:"createdAt"`
        UpdatedAt           string `json:"updatedAt"`
    }

    // Redacted response (product users)
    type tierSummaryResponse struct {
        ID          string `json:"id"`
        Name        string `json:"name"`
        Description string `json:"description"`
    }
    ```

- [ ] **Tier validation**: `internal/api/validation/tier.go`
  - Reuses existing `nameRegex` from `database.go` (DNS-compatible, 3–63 chars)
  - Validation rules:
    - `name`: required, must match `nameRegex`, no consecutive hyphens
    - `description`: optional (defaults to empty string), max 1000 chars
    - `instances`: required, must be between 1 and 10
    - `cpu`: required, must match K8s resource quantity pattern (e.g., `100m`, `1`, `2.5`)
    - `memory`: required, must match K8s resource quantity pattern (e.g., `128Mi`, `1Gi`, `4Gi`)
    - `storageSize`: required, must match K8s storage format (e.g., `1Gi`, `10Gi`, `500Mi`)
    - `storageClass`: optional (defaults to empty string), max 255 chars
    - `pgVersion`: required, must be one of `"15"`, `"16"`, `"17"`
    - `poolMode`: required, must be one of `"transaction"`, `"session"`, `"statement"`
    - `maxConnections`: required, must be between 10 and 10000
    - `destructionStrategy`: required, must be one of `"freeze"`, `"archive"`, `"hard_delete"`
    - `backupEnabled`: required (boolean, defaults to false)
  - Returns `[]FieldError` (same pattern as `validation.ValidateCreateRequest`)
  - Separate validation function for update: `ValidateUpdateTierRequest` — validates only provided (non-nil) fields, `name` is rejected as immutable at handler level

- [ ] **Refactor `POST /databases` to require `tier`**: Modify `internal/api/handler/database.go`
  - Update `createDatabaseRequest`:
    ```go
    type createDatabaseRequest struct {
        Name      string `json:"name"`
        OwnerTeam string `json:"ownerTeam"`
        Tier      string `json:"tier"`      // NEW: tier name (required)
        Purpose   string `json:"purpose"`
        Namespace string `json:"namespace"`
    }
    ```
  - Validation: `tier` is required; resolved to tier ID via `tierRepo.GetByName()`
  - If tier not found → 404 `NOT_FOUND` with message "Tier not found"
  - The resolved `Tier` object is passed to the template builders (replaces hardcoded defaults)
  - The `tier_id` is stored on the database record

  - Update `databaseResponse`:
    ```go
    type databaseResponse struct {
        // ... existing fields ...
        Tier string `json:"tier"` // NEW: tier name
    }
    ```
  - `toDatabaseResponse` populates `Tier` from `db.TierName`

  - Update `DatabaseHandler` struct:
    ```go
    type DatabaseHandler struct {
        repo     database.Repository
        manager  k8s.ResourceManager
        teamRepo team.Repository
        tierRepo tier.Repository  // NEW
        ns       string
    }
    ```

- [ ] **Update database validation**: `internal/api/validation/database.go`
  - Add `Tier string` to `CreateDatabaseRequest` struct
  - Add validation: `tier` is required (non-empty after TrimSpace)
  - Error: `{field: "tier", message: "tier is required"}`

- [ ] **Update database model**: `internal/database/model.go`
  - Add to `Database` struct:
    ```go
    TierID   *uuid.UUID // nullable for pre-v0.5 databases
    TierName string     // transient, populated via JOIN
    ```
  - No change to `ListFilter` — no tier-based filtering needed yet
  - No change to `UpdateFields` — tier is immutable on a database (changing infrastructure post-creation is not supported)

- [ ] **Update database repository**: `internal/database/postgres_repository.go`
  - `Create()`: include `tier_id` in INSERT
  - `GetByID()`: JOIN `tiers` to populate `TierName` (LEFT JOIN since pre-v0.5 databases have NULL tier_id)
  - `List()`: JOIN `tiers` to populate `TierName` (LEFT JOIN)
  - Add `ErrInvalidTier` sentinel error (FK violation on tier_id)

- [ ] **Refactor template builders**: `internal/k8s/template/cluster.go` and `pooler.go`
  - Remove `defaultInstances`, `defaultStorageSize`, `defaultPGVersion` constants
  - Update `ClusterParams`:
    ```go
    type ClusterParams struct {
        Name         string
        Namespace    string
        Instances    int
        CPU          string // K8s resource quantity
        Memory       string // K8s resource quantity
        StorageSize  string
        StorageClass string // empty = cluster default
        PGVersion    string
    }
    ```
  - `BuildCluster()` uses params instead of hardcoded values:
    - `spec.instances` → `params.Instances`
    - `spec.storage.size` → `params.StorageSize`
    - `spec.storage.storageClass` → `params.StorageClass` (only set if non-empty)
    - `spec.imageName` → built from `params.PGVersion`
    - `spec.resources.requests.cpu` → `params.CPU`
    - `spec.resources.requests.memory` → `params.Memory`
    - `spec.resources.limits.cpu` → `params.CPU`
    - `spec.resources.limits.memory` → `params.Memory`

  - Update `PoolerParams`:
    ```go
    type PoolerParams struct {
        Name           string
        Namespace      string
        ClusterName    string
        PoolMode       string // "transaction", "session", "statement"
        MaxConnections int
    }
    ```
  - `BuildPooler()` uses params:
    - `spec.pgbouncer.poolMode` → `params.PoolMode`
    - `spec.pgbouncer.parameters.default_pool_size` → derived from `params.MaxConnections` (or set directly)

  - The handler maps `Tier` fields to `ClusterParams` and `PoolerParams` before calling builders

- [ ] **Router updates**: `internal/api/router.go`
  - Add `TierRepo tier.Repository` to `RouterDeps`
  - Register tier routes in the authenticated business group:
    ```
    Authenticated group (middleware.Auth):
      Superuser-only group (RequireSuperuser):
        ... (teams, users — unchanged)

      Business group (RequireRole("platform", "product")):
        GET    /tiers           (all business users)
        GET    /tiers/{id}      (all business users)

      Platform-only group (RequireRole("platform")):
        POST   /tiers           (platform users only)
        PATCH  /tiers/{id}      (platform users only)
        DELETE /tiers/{id}      (platform users only)

      Business group (RequireRole("platform", "product")):
        ... (databases — unchanged, except handler now requires tierRepo)
    ```
  - Note: `GET /tiers` routes are in the business group (platform + product), while tier mutations are in a new platform-only group
  - Update `NewDatabaseHandler` call to include `deps.TierRepo`

- [ ] **Update `cmd/server/main.go`**:
  - Init tier repository: `tierRepo := tier.NewPostgresRepository(pool)`
  - Pass `TierRepo` to `RouterDeps`
  - Pass `tierRepo` to `NewDatabaseHandler`

- [ ] **Update OpenAPI spec**: Add to `api/openapi.yaml`:
  - New tag: `tiers` (platform-managed infrastructure profiles)
  - New paths:
    - `POST /tiers` — create a tier (platform-team only)
    - `GET /tiers` — list all tiers (all business users)
    - `GET /tiers/{id}` — get a tier (all business users)
    - `PATCH /tiers/{id}` — update a tier (platform-team only)
    - `DELETE /tiers/{id}` — delete a tier (platform-team only)
  - New schemas:
    - `Tier` — full tier with all infrastructure fields
    - `TierSummary` — redacted tier (id, name, description only)
    - `CreateTierRequest` — all tier fields
    - `UpdateTierRequest` — all fields optional (except immutable `name`)
    - `TierResponse` — `{data: Tier, ...}` (platform users)
    - `TierSummaryResponse` — `{data: TierSummary, ...}` (product users — documented as alternative response)
    - `TierListResponse` — `{data: [Tier], ...}` with list meta
  - Update `CreateDatabaseRequest` schema: add required `tier` field (string, tier name)
  - Update `Database` response schema: add `tier` field (string, tier name)
  - New error code: `TIER_HAS_DATABASES` (409)
  - Add 401/403 responses to all tier endpoints

- [ ] **New unit tests** (in `tests/unit/`):
  - `tier/repository_test.go` — tier CRUD, duplicate name, delete with databases, GetByName
  - `api/handler/tier_test.go` — create, list, get, update, delete; validation errors; auth/role checks; product user sees redacted view
  - `api/validation/tier_test.go` — all field validations (name regex, instances bounds, pool_mode enum, etc.)
  - `k8s/template/cluster_test.go` — update existing tests: verify tier params flow through (instances, storage, CPU, memory, PG version, storage class)
  - `k8s/template/pooler_test.go` — update existing tests: verify pool_mode and max_connections flow through
  - `api/handler/database_test.go` — update existing tests: verify `tier` field required, tier resolution, tier name in response

- [ ] **Update integration tests** (in `tests/integration/api/`):
  - Update `auth_test.go`: create a tier before creating databases (POST /databases now requires `tier`)
  - Add tier lifecycle tests: platform user creates tier → product user sees redacted list → platform user updates tier → creates database with tier → cannot delete tier with active databases → delete database → delete tier
  - Verify product user cannot create/update/delete tiers (403)

- [ ] **Update README.md**: Document the tier system — what tiers are, how to create them, how they affect database creation, platform vs. product user views

## Codebase Impact

| Area | Current State | Changes Needed |
|------|--------------|----------------|
| `internal/tier/` | Does not exist | New package: `model.go`, `repository.go`, `postgres_repository.go` |
| `internal/api/handler/` | 5 files: `health.go`, `database.go`, `openapi.go`, `team.go`, `user.go` | Add `tier.go`; modify `database.go` (add tier field + tier repo dep) |
| `internal/api/validation/` | 3 files: `database.go`, `team.go`, `user.go` | Add `tier.go`; modify `database.go` (add `tier` field validation) |
| `internal/api/router.go` | 3 route groups (public, superuser, business) | Add platform-only group for tier mutations; update business group for tier reads |
| `internal/database/model.go` | No tier reference | Add `TierID *uuid.UUID`, `TierName string` fields |
| `internal/database/postgres_repository.go` | JOINs teams for OwnerTeamName | Add LEFT JOIN on tiers for TierName; include tier_id in INSERT |
| `internal/k8s/template/cluster.go` | Hardcoded `defaultInstances=1`, `defaultStorageSize=1Gi`, `defaultPGVersion="16"` | Remove defaults; accept all params from tier; add CPU/memory resource limits |
| `internal/k8s/template/pooler.go` | Hardcoded `poolMode="transaction"` | Accept `poolMode` and `maxConnections` from tier |
| `internal/api/handler/database.go` | `createDatabaseRequest` has no tier field; `DatabaseHandler` has no tier repo | Add `tier` to request; add `tierRepo` to handler; resolve tier name → ID; pass tier to builders |
| `internal/api/validation/database.go` | Validates `name`, `ownerTeam` | Add `tier` validation (required) |
| `internal/api/router.go` `RouterDeps` | 10 fields | Add `TierRepo tier.Repository` |
| `cmd/server/main.go` | Inits DB, K8s, auth, team, user | Add: init tier repo, pass to RouterDeps |
| `migrations/` | 7 files (001–007) | Add `008_create_tiers.sql`, `009_add_tier_id_to_databases.sql` |
| `api/openapi.yaml` | ~1220 lines, tags: system, teams, users, databases | Add `tiers` tag, 5 new paths, ~7 new schemas, 1 new error code |
| `tests/unit/` | ~20 test files | Add ~3 new files; update ~3 existing files |
| `tests/integration/api/` | 2 files | Update existing tests; add tier lifecycle coverage |

## New Dependencies

None. All required modules are already in `go.mod`:
- `github.com/go-chi/chi/v5` — HTTP router
- `github.com/google/uuid` — UUID generation
- `github.com/jackc/pgx/v5` — PostgreSQL driver
- No new external services or infrastructure

## Non-Goals

- Tier enforcement on running databases — changing a tier's parameters does not retroactively alter existing databases
- Default tier / auto-selection — platform must explicitly create a tier; there is no implicit "default" tier
- Destruction strategy enforcement — the `destructionStrategy` column is stored but has no runtime effect until v0.8
- Backup enforcement — the `backupEnabled` column is stored but has no runtime effect until v0.6
- Tier quotas (max databases per tier, resource limits) — deferred to v0.7
- Tier versioning / migration tooling — deferred post-v1
- HA replica count as separate field — for v0.5, `instances` controls the total replica count including the primary
- Pagination on `/tiers` — expected count is small (< 50)

## Dependencies

- **v0.4** (shipped): RBAC middleware (`RequireRole`, `RequireSuperuser`) for access control on tier endpoints
- **ADR 004** (superseded by ADR 007): The new ADR documents how tiers replace hardcoded defaults
- Existing platform database (PostgreSQL 16 via pgx) for `tiers` table
- Existing template builders in `internal/k8s/template/` — refactored, not replaced

## Corrections from Roadmap

| Roadmap Description | Resolution |
|--------------------|------------|
| Roadmap lists: `instances, cpu, memory, storage_size, storage_class, pg_version, ha_replicas, pool_mode, max_connections, destruction_strategy, backup_enabled` | Dropped `ha_replicas` — `instances` already controls the total replica count (primary + standbys). CNPG's `instances` field is the total number of pods. Separate `ha_replicas` would be redundant and confusing. |
| Roadmap says "Product-team-facing view: GET /tiers returns human-readable descriptions of guarantees only (no infrastructure parameters exposed)" | Implemented as role-based response redaction: product users see `{id, name, description}` only; platform users see all fields. Same endpoint, different response shapes based on identity role. |
| Roadmap says tier mutations are "platform-team only via the auth middleware from v0.4" | Confirmed: uses `RequireRole("platform")` — a new route group narrower than the existing `RequireRole("platform", "product")` business group. |
| Roadmap says "Tier deletion guard: cannot delete a tier that has active databases" | Implemented via `ON DELETE RESTRICT` FK on `databases.tier_id` + application-level sentinel error `ErrTierHasDatabases`. "Active" means non-deleted (soft-deleted databases excluded). |
| Roadmap says `POST /databases` "require a tier field instead of using hardcoded defaults" | The `tier` field in `POST /databases` is a tier **name** (string), matching the `ownerTeam` pattern. Resolved to UUID internally. |
| Roadmap says "cluster/pooler templates read config from the tier" | `ClusterParams` and `PoolerParams` expanded with tier fields. Template builders become pure functions of params — no more hardcoded constants. |

## Acceptance Criteria

- `make build` succeeds with `internal/tier/` package and all modifications
- `make test` passes, including all new unit tests and updated existing tests
- `make lint` passes with no new warnings
- `make lint-openapi` passes with the updated `api/openapi.yaml`
- **Tier creation**: `curl -X POST localhost:8080/tiers -H "X-API-Key: $PLATFORM_KEY" -d '{"name":"standard","description":"Standard dev tier","instances":1,"cpu":"500m","memory":"512Mi","storageSize":"1Gi","pgVersion":"16","poolMode":"transaction","maxConnections":100,"destructionStrategy":"hard_delete","backupEnabled":false}'` returns 201
- **Tier listing (platform)**: `curl localhost:8080/tiers -H "X-API-Key: $PLATFORM_KEY"` returns all tiers with full infrastructure details
- **Tier listing (product)**: `curl localhost:8080/tiers -H "X-API-Key: $PRODUCT_KEY"` returns all tiers with only `id`, `name`, `description`
- **Tier get**: `curl localhost:8080/tiers/{id} -H "X-API-Key: $PLATFORM_KEY"` returns full tier
- **Tier update**: `curl -X PATCH localhost:8080/tiers/{id} -H "X-API-Key: $PLATFORM_KEY" -d '{"instances":2}'` returns 200 with updated tier
- **Tier deletion guard**: `curl -X DELETE localhost:8080/tiers/{id} -H "X-API-Key: $PLATFORM_KEY"` returns 409 `TIER_HAS_DATABASES` when databases exist
- **Database creation with tier**: `curl -X POST localhost:8080/databases -H "X-API-Key: $PLATFORM_KEY" -d '{"name":"mydb","ownerTeam":"ops","tier":"standard","purpose":"testing"}'` returns 201 with `tier: "standard"` in response
- **Database creation without tier**: `curl -X POST localhost:8080/databases -H "X-API-Key: $PLATFORM_KEY" -d '{"name":"mydb","ownerTeam":"ops"}'` returns 400 with `tier is required`
- **Database response includes tier**: `curl localhost:8080/databases/{id} -H "X-API-Key: $PLATFORM_KEY"` includes `"tier": "standard"` in response
- **Product user blocked from tier mutations**: `curl -X POST localhost:8080/tiers -H "X-API-Key: $PRODUCT_KEY" -d '...'` returns 403
- **Superuser blocked from tier endpoints**: `curl localhost:8080/tiers -H "X-API-Key: $SUPERUSER_KEY"` returns 403
- **K8s cluster uses tier params**: CNPG Cluster created with `instances`, `storageSize`, `cpu`, `memory`, `pgVersion` from the selected tier (verifiable in integration tests or via `kubectl`)
- **K8s pooler uses tier params**: CNPG Pooler created with `poolMode` from the selected tier
- **Route coverage test** passes with the 5 new tier paths
- All existing database and auth integration tests pass (updated to create a tier first)
